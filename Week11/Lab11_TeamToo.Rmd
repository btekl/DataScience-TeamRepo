---
title: 'Lab 11: Baby Names'
author: "Brian Teklits, Charles Doremieux, Andrew MacLean, Clint LaBattaglia"
date: "11/10/2019"
output: html_document
---

```{r setup, include=FALSE}
library(tidyverse)
library(stringr)
library(babynames)
knitr::opts_chunk$set(warning=FALSE,message=FALSE)

babys18 <- read_csv('yob2018.txt',col_types = cols(
                    name = col_character(),
                    sex = col_character(),
                    n = col_double()))

babys18 <- babys18 %>%
  mutate(prop = n/sum(n)) %>%
  mutate(year = 2018)

babys <- babynames %>%
  full_join(babys18)
```

### Individual Name Popularity

#### Andrew

```{r}
and <- babys %>%
  filter(str_detect(name, "^And")) %>%
  group_by(year) %>%
  summarise(and_prop = sum(prop))

andrew <- babys %>%
  filter(str_detect(name,"^And[y|rew]"),sex=='M')%>%
  group_by(year) %>%
  summarize(andrew_prop = sum(prop))

ggplot()+
  geom_line(data=and,aes(year,and_prop,color='And Names'))+
  geom_line(data=andrew,aes(year,andrew_prop,color='Andrew Names'))+
  scale_color_manual(name='',values=c(`And Names`='blue', `Andrew Names`='green'))+
  ylab("Proportion of Total")+
  xlab("Year")+
  ggtitle("Proportion of Names over Time")
```

I decided to find names that specfically start with 'And' such as Anderson and Anders, but excluded names such as Drew or female variations such as Andrea. It was interesting to see that a large majority of 'And' names were within the few I chose to include. My name is a very popular one but recently have starting to die down.

#### Brian

```{r}
bri <- babys %>%
  filter(str_detect(name, "^Bri")) %>%
  group_by(year) %>%
  summarise(bri_prop = sum(prop))

brian <- babys %>%
  filter(str_detect(name,"^Br[iy][oa]n"),sex=='M')%>%
  group_by(year) %>%
  summarize(brian_prop = sum(prop))

ggplot()+
  geom_line(data=bri,aes(year,bri_prop,color='Bri Names'))+
  geom_line(data=brian,aes(year,brian_prop,color='Brian Names'))+
  geom_vline(aes(xintercept = 1995, color='1995'), linetype='dashed')+
  scale_color_manual(name='',values=c(`Bri Names`='red', `Brian Names`='black', `1995`='blue'))+
  ylab("Proportion of Total")+
  xlab("Year")+
  ggtitle("Proportion of Names over Time")
```

I used the regex "^Br[iy][oa]n" to match names similar to Brian. I opted not to exclude variants like Bryant, but did restrict based on sex, to exclude variants more commonly female, such as Brianna.

Popularity of both variants of Brian and names beginning with Bri both peaked prior to 1995, consistently decreasing since then. Brian variants peaked between 1960 and 1980, when their proportion was greater than names beginning with Bri. Following this peak, popularity has steadily decreased while names beginning with Bri, and not consisting of Brian variants, peaked in popularity just prior to 1995.

#### Charles
```{r}
first_3 <- babys %>%
  filter(str_detect(name, "^Cha")) %>%
  group_by(year) %>%
  summarise(chap = sum(prop))

similar <- babys %>%
  filter(str_detect(name,"^Charl[ie][sey]"),sex=='M')%>%
  group_by(year) %>%
  summarize(chap = sum(prop))

charles <- babys %>%
  filter(str_detect(name,"^Charles"),sex=='M')%>%
  group_by(year) %>%
  summarize(chap = sum(prop))

#View(charles)

ggplot()+
  geom_line(data = first_3, aes(year, chap, color = 'Names with "cha"'))+
  geom_line(data = charles, aes(year, chap, color = 'Charles'))+
  scale_color_manual(name='')+
  ylab("Proportion of Total Names ")+
  xlab("Year")+
  scale_color_manual(name='',values=c(`Names with "cha"`='red', `Charles`='black'))+
  ggtitle("Proportion of Total Names over Time")
```

#### Clint
```{r}
just_name <- babys%>%
  filter(str_detect(name,"^Clint[^e]"),sex=='M')%>%
  group_by(year)

my_name_3 <- babys %>%
  filter(str_detect(name, "^Cli")) %>%
  group_by(year) %>%
  summarise(cli_prop = sum(prop))

my_name <- babys %>%
  filter(str_detect(name,"^Clint"),sex=='M')%>%
  group_by(year) %>%
  summarize(clint_prop = sum(prop))

ggplot()+
  geom_line(data= my_name_3, aes(year, cli_prop,color='Cli Names'))+
  geom_line(data=my_name, aes(year, clint_prop, color='Clint Names'))+
  scale_color_manual(name='',values=c(`Cli Names`='Purple', `Clint Names`='Red'))+
  ylab("Proportion of Total Names ")+
  xlab("Year")+
  ggtitle("Proportion of Total Names over Time")
```

### Ariel and Rachel Regex

We decided to include variants such as Arielle and Ariela in our calculations. The total versions of Ariel by year: 
```{r}
Ariel <- "A[r]+[iy]+.l+.*"
babys %>%
  filter(str_detect(name,Ariel),year %in%c(1973,1988,1990),sex=="F") %>%
  group_by(year)%>%
  summarise(Ariel_Variants = n())
```
We chose to only include variants which ended with 'l'. Variants ending in other letters (Rachelle, Rachelanne, etc.) have significantly differing pronounciations and were thus excluded. The number of versions of Rachel:
```{r}
Rachel <- "Ra[ey]?ch.*l$"
babys %>%
  filter(str_detect(name,Rachel),year %in%c (1973,1988,1990),sex=='F')# %>%
#  group_by(year) %>%
 # summarise(Rachel_Variants = n())
```
The chance a girl would be named a variant of either Rachel or Ariel, for the given years:
```{r}
babys %>%
  filter(str_detect(name,Ariel) | str_detect(name,Rachel),year%in%c(1973,1988,1990,2018),sex=='F') %>%
  group_by(year) %>%
  summarise(Ariel_or_Rachel = sum(prop))
```

### The Little Mermaid Effect

To investigate how the proportion of names changed from 1988 to 1990, we create a variable describing the change in proportion between the years. NA values are replaced with zero, as they represent a name that was not present in the dataset for one of the years. First, we investigate female baby names beginning with vowels:
```{r}
vowel_f_88 <- babys %>%
  filter(str_detect(name,"^[AEIOU]"),sex=='F', year == 1988) 
vowel_f_diff <- babys %>%
  filter(str_detect(name,"^[AEIOU]"), sex=='F', year == 1990) %>%
  full_join(vowel_f_88, by = "name") %>%
  replace_na(list(prop.x=0, prop.y=0)) %>% # replace names which didn't exist in one of the years with 0
  mutate(prop_change = (prop.x-prop.y))
```
Similarly, we calculate the change in proportion for just Ariel variants, and get the total change in proportion for all variants of Ariel combined:
```{r}
ariel_names <- babys %>%
  filter(str_detect(name,Ariel, year %in% c(1988,1990)))

(ariel_prop <- vowel_f_diff %>%
  semi_join(ariel_names) %>%
  summarise(prop_change = sum(prop_change)))
```
When we look at the change in proportion of female names beginning with a vowel, in terms of percentile, our Ariel variants are at:
```{r}
percentile_change <- ecdf(vowel_f_diff$prop_change)
percentile_change(ariel_prop) 
```
Ariel variants are at the 100th percentile of change in proportion among female names beginning with a vowel. However, we're comparing the total change of 12 names (all Ariel variants) to the change in only a single name. So while the total change appears significant, this result may overstate exactly how large the increase in Ariel names actually was.

To get a better idea of how significant this result is, we can compare it to the entire set of female names. We construct the same data, but for the entire set of names in 1988 and 1990:
```{r}
f_88 <- babys %>%
  filter(sex == 'F',year == 1988)

top_changes <- babys %>%
  filter(sex == 'F', year == 1990) %>%
  full_join(f_88, by = "name") %>% 
  replace_na(list(prop.x=0, prop.y=0)) %>%
  mutate(prop_change = (prop.x-prop.y)) %>%
  filter(min_rank(desc(prop_change)) < 15) %>%
  full_join(ariel_prop) %>%
  replace_na(list(name = "Ariel and Variants"))

ggplot()+
  geom_point(data=top_changes, aes(fct_reorder(name,prop_change), prop_change))+
  coord_flip()+
  ggtitle("Top 15 Increases in Proportion for Female Names from 1988 to 1990") +
  xlab("")+
  ylab("Change in Proportion of Total")
```

Ariel variants have the 6th largest increase from 1988 to 1990. The name Ariel alone had the 11th largest increase among female names, not including variants of Ariel in the ranking. The overall rankings of these names would likely change, should we aggregate the various spellings for all the names into single categories, as we did for Ariel. However, the high placement of both Ariel alone, and it's aggregated variants suggests a substantial increase in the 2 year period, larger than the vast majority of female names in the same period.

From this, we conclude *The Little Mermaid* did cause an increase in female babies named Ariel in 1990.  

### Changes Among Our Names

```{r}
# Calculates total change in proportion between two years, for all matches of a given regex. Assumes gender is male
get_prop_change <- function(year_from,year_to,regex)
{
  before <- babys %>%
    filter(sex == 'M', year == year_from, str_detect(name,regex))
  before_and_after <- babys %>%
    filter(sex == 'M', year == year_to,str_detect(name,regex)) %>%
    full_join(before, by = "name") %>% 
    replace_na(list(prop.x=0, prop.y=0)) %>%
    mutate(prop_change = (prop.x-prop.y)) %>%
    summarise(total = sum(prop_change))
  return(before_and_after$total)
}

get_allnames_prop_change <- function(year_start,year_end)
{
  all_names_1 <- babys %>%
    filter(sex == 'M', year == year_start)
  all_names <- babys %>%
    filter(sex == 'M', year == year_end) %>%
    full_join(all_names_1, by = "name") %>% 
    replace_na(list(prop.x=0, prop.y=0)) %>%
    mutate(prop_change = (prop.x-prop.y))
}
```

#### Andrew

#### Brian

The actual change in Brian names from 1972 to 1995:
```{r}
get_prop_change(1972,1995,"^Br[iy][oa]n")
```
The relative change:
```{r}
percentile_before <- ecdf(get_allnames_prop_change(1972,1995)$prop_change)
percentile_before(get_prop_change(1972,1995,"^Br[iy][oa]n"))
```
Brian names decreased substantially in popularity over this period: essentially in the 0th percentile.

The actual change in Brian names from 1995 to 2018:
```{r}
get_prop_change(1995,2018,"^Br[iy][oa]n")
```
The relative change:
```{r}
percentile_before <- ecdf(get_allnames_prop_change(1995,2018)$prop_change)
percentile_before(get_prop_change(1995,2018,"^Br[iy][oa]n"))
```

#### Charles

#### Clint


#### Histograms

We chose to only look at the exact spellings for our names, as all saw changes outside the normal range, so including additional spellings moved them even farther away, making it difficult to visualize.

We restricted to only male names, as all of our names and variants were male. We also chose to use the smallest age range, as this still covered most of the same years.
```{r}
our_props <- c(get_prop_change(1980,1999,"^Andrew$"),
               get_prop_change(1980,1999,"^Brian$"), get_prop_change(1980,1999,"^Charles$"),
               get_prop_change(1980,1999,"^Clint$"))
```

```{r}
ggplot(get_allnames_prop_change(1980,1999),aes(prop_change))+
  geom_histogram(bins=100)+
  xlim(-.0009,.00125)+
  geom_vline(xintercept = our_props,color='red')
```

The plot is scaled to try to keep shape of the distribution visible while still showing our names. Andrew (right) and Clint (left) are pictured, Charles and Brian lie even farther to the left. All our names saw significant changes, with only Andrew increasing, the rest decreased.

The second age range:
```{r}
our_props2 <- c(get_prop_change(1999,2018,"^Andrew$"),
               get_prop_change(1999,2018,"^Brian$"), get_prop_change(1999,2018,"^Charles$"),
               get_prop_change(1999,2018,"^Clint$"))
ggplot(get_allnames_prop_change(1999,2018),aes(prop_change))+
  geom_histogram(bins = 100)+
  xlim(-.00006,.00006)+
  geom_vline(xintercept = our_props2,color='red')
```

Only Clint falls reasonably close to the peak of the distribution, all the other names are far to the left, indicating significant decreases in the popularity of Brian, Charles and Andrew.

### Baby Name Recommendations



### Individual Contributions

**Andrew:**

**Brian:**

**Charles:**
```{r}
after_birth <- charles %>% filter(year >= 1999)
before_birth <- charles %>% filter(year < 1999, year > 1980)

ggplot(data = after_birth) + 
  geom_line(aes(year, chap))+
  xlab("Year")+
  ylab("Proportion of Total Names")+
  ggtitle("Charles Name Popularity Since 1999")

ggplot(data = before_birth) + 
  geom_line(aes(year, chap))+
  xlab("Year")+
  ylab("Proportion of Total Names")+
  ggtitle("Charles Name Popularity 1980-1999")
```
**Clint:**

```{r}
birth_name <- my_name%>%
  filter(year > 1998)

birth_name_2 <- my_name%>%
  filter(year < 1999, year >1979)

ggplot(data = birth_name) + 
  geom_line(aes(year, clint_prop))+
  ylab("Proportion of Total Names ")+
  xlab("Year")+
  ggtitle("Proportion of Babies Named Clint Since 1999")

ggplot(data = birth_name_2) + 
  geom_line(aes(year, clint_prop))+
  ylab("Proportion of Total Names ")+
  xlab("Year")+
  ggtitle("Proportion of Babies Named Clint Since From 1979 to 1999")
```

```{r}
my_1999 <- just_name%>%
  filter(year == "1999")

my_2018 <- just_name%>%
  filter(year == "2018")%>%
  full_join(my_1999, by = "name")%>%
  mutate(prop_change = (prop.y-prop.x))%>%
  summarise(total_change = sum(prop_change))

my_1980 <- just_name%>%
  filter(year == "1980")%>%
  full_join(my_1999, by = "name")%>%
  mutate(prop_change = (prop.x-prop.y))%>%
  summarise(total_change = sum(prop_change))

ggplot()+
  geom_col(data = my_1980, aes(x= year.x,  y= total_change, color = "1980-1999"))+
  geom_col(data = my_2018, aes(x= year.x,  y= total_change, color = "1999-2018"))+
  scale_color_manual(name='',values=c(`1980-1999`='red', `1999-2018`='purple'))
```
