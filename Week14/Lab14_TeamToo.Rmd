---
title: 'Lab 14: Using modeling and iteration to expand a previous lab'
author: "Brian Teklits, Charles Doremieux, Andrew MacLean, Clint LaBattaglia"
date: "12/6/2019"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(warning=FALSE,message=FALSE)
library(tidyverse)
library(gapminder)
library(modelr)
```

## Overall question

We chose to revisit Lab 12: Gapminder Permutations, where we answered the following question:

How does life expectancy differ between the richest and poorest countries (in terms of per capita gdp)?

While we might anticipate that richer countries have longer life expectancies than poorer countries, verifying that this is the case can still provide useful insights. The degree to which they differ can inform us of how a country with a low life expectancy would want to improve their citizens health. Low life expectancy could be viewed as both a health infrastructure and economic problem.

### Conclusions

First, we split the data into the high and low gdp countries. For each set, we will build and analyze a model for how gdp per capita relates to life expectancy. 
```{r}
low_gdp <- gapminder %>%
  filter(min_rank(gdpPercap)<=500)
high_gdp <- gapminder %>%
  filter(min_rank(desc(gdpPercap))<=500)
```
We opted to split these datasets further into training and testing groups, building our models with the training datasets then testing their effectiveness with the test datasets. We used 80% of the data for the training dataset in each case.
```{r}
# code referenced from https://stackoverflow.com/questions/17200114/how-to-split-data-into-training-testing-sets-using-sample-function
bound <- floor((nrow(low_gdp))*.8)         #define % of training and test set

low <- low_gdp[sample(nrow(low_gdp)), ]            
low_train <- low[1:bound, ]              #get training set
low_test <- low[(bound+1):nrow(low), ]

# high dataset is same size, so we can reuse the same bound
high <- high_gdp[sample(nrow(high_gdp)), ]           
high_train <- high[1:bound, ]              
high_test <- high[(bound+1):nrow(high), ]
```

#### Low GDP Model

First, we'll look at the low GDP countries, building our model and then calculating predictions and residuals.
```{r}
low_model <- lm(lifeExp ~ gdpPercap, data = low_train)
low_predict <- low_train %>% add_predictions(low_model)
low_resid <- low_train %>% add_residuals(low_model)
low_test_resid <- low_test %>% add_residuals(low_model)
```
Our linear model for life expectancy as a function of gdp per capita:
```{r}
ggplot()+
  geom_line(data=low_predict,aes(gdpPercap,pred))
```

The residuals for the training dataset:
```{r}
ggplot(low_resid,aes(gdpPercap,resid))+
  geom_line()
```

The residuals for the test dataset:
```{r}
ggplot(low_test_resid,aes(gdpPercap,resid))+
  geom_line()
```

Our model for low gdp countries appears to have some issues, as we have large residuals in both datasets for the entire range of gdp per capita. There does seem to be relationship between life expectancy and gdp per capita, but other hidden variables are at play.

#### High GDP Model

Again, we build our linear model off the training dataset, then calculate predictions and residuals:
```{r}
high_model <- lm(lifeExp ~ gdpPercap, data = high_train)
high_predict <- high_train %>% add_predictions(high_model)
high_resid <- high_train %>% add_residuals(high_model)
high_test_resid <- high_test %>% add_residuals(high_model)
```

The linear model for high GDP countries:
```{r}
ggplot()+
  geom_line(data=high_predict,aes(gdpPercap,pred))
```

Residuals for the training data:
```{r}
ggplot(high_resid,aes(gdpPercap,resid))+
  geom_line()
```

Residuals for the test data:
```{r}
ggplot(high_test_resid,aes(gdpPercap,resid))+
  geom_line()
```

The model for high GDP has some significant outliers: in the training dataset, there are very rich countries with far lower life expectancies than predicted. The test data doesn't contain countries at that level of wealth, and has lower residuals overall.

So, while we found there is some validity to our original conclusion that life expectancy is related to gdp per capita, our model suggests there is a lot more going on. We have substantial outliers as well as inconsistent accuracy across the entire range of GDP. We will investigate some of the potential sources of our model's error in the individual sections.

### Summary of Modeling Techniques

We used the modelr methods for calculating predictions and residuals for our linear models. We also split our data into model building and model validation subsets.

Add some other stuff from individual sections

## Individual Sections

### Andrew

### Brian

What factors are causing our initial life expectancy vs GDP per capita model to be inaccurate? Are we able to manipulate and filter the data to recover a linear (or otherwise) pattern between life expectancy and GDP? 

This question is a natural follow up to our initial team findings. Our initial model fails quite poorly in some cases; by investigating further, we can try to establish if there is a relationship between the variables of interest, or if our model is flawed in some other way.

We discovered that nearly all of the model's worst predictions are on countries in Africa and Asia. (Varies between different models as training data is sampled differently each model, but typically just 1 of the 30 worst predictions by residuals is not from these 2 continents.) So, we'll remove these two continents to see if we can get a more accurate model by excluding the largest outliers.
```{r}
g2 <- gapminder %>% 
  filter(continent != "Africa" & continent != "Asia") %>%
  mutate(lgdp = log10(gdpPercap))

bounds <- floor((nrow(g2))*.8)         
b_data <- g2[sample(nrow(g2)), ]            
b_train <- b_data[1:bounds, ]              
b_test <- b_data[(bounds+1):nrow(g2), ]
```
I opted to convert GDP per capita to lgdp, the base 10 log of GDP per capita in order to help coerce a linear relationship out of the variables. I also opted to include year and country and modeled using the "*" operation as these variables seemed likely to have interactions between each other as well as with life expectancy.
```{r}
model1 <- lm(lifeExp ~ lgdp*year*country, data = b_train)
predict1 <- b_train %>% add_predictions(model1)
resid1 <- b_train %>% add_residuals(model1)
test_resid1 <- b_test %>% add_residuals(model1)

ggplot(predict1,aes(lgdp,pred))+
  geom_line()+
  geom_smooth(se=FALSE)+
  ggtitle("Life Expectancy vs GDP (Base 10 Log)")+
  ylab("Predicted Life Expectancy")+
  xlab("Logarithm of GDP per Capita")
```

We find a fairly linear relationship between these variables: increasing GDP by a factor of 10 increases life expectancy by around 20 years, according to this model.

Looking at the residuals:
```{r}
ggplot(resid1,aes(lgdp,resid))+
  geom_line()+geom_smooth(se= FALSE)+
  ggtitle("Residuals for Training Dataset")+
  xlab("Logarithm of GDP per Capita")
```

```{r}
ggplot(test_resid1,aes(lgdp,resid))+
  geom_line()+geom_smooth(se = FALSE)+
  ggtitle("Residuals for Testing Dataset")+
  xlab("Logarithm of GDP per Capita")
```

Overall, this model does quite a bit better at producing more accurate predictions than our initial model. The model predicts the test data with similar accuracy to the training data. By introducing both year and country into the model, we run the risk of overfitting; however, the test data suggests we've mostly avoided this issue.

### Charles

### Clint

### Individual Contributions

**Andrew:**

**Brian:** I built a variety of models for both the team and individual sections to test different interactions. In doing so, I used various transformations (logarithmic variables/predictions/residuals), as well as incorporating the training and testing data split methods.

**Charles:**

**Clint:**
