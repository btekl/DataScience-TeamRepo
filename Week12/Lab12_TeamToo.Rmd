---
title: 'Lab 12: Gapminder Permutations'
author: "Brian Teklits, Charles Doremieux, Andrew MacLean, Clint LaBattaglia"
date: "11/15/2019"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(warning=FALSE,message=FALSE)
library(tidyverse)
library(gapminder)
data <- gapminder # replace w/ updated dataset
```

### Gapminder Dataset

The gapminder dataset contains life expectancy, population, and GDP per capita data on 142 countries, across 5 continents (North/South America are combined into Americas).

### Questions of Interest

**First Question:** How does life expectancy differ between the richest and poorest countries (in terms of per capita gdp)?

While we might anticipate that richer countries have longer life expectancies than poorer countries, verifying that this is the case can still provide useful insights. The degree to which they differ can inform us of how a country with a low life expectancy would want to improve their citizens health. Low life expectancy could be viewed as both a health infrastructure and economic problem.

**Second Question:** Are there any unintuitive correlations in the dataset? If so, do these correlations exist in the updated dataset as well, or are they a result of some specific characteristics of countries and years in the base gapminder dataset?

Some variables relate to each other in obvious ways, while for others the connection is not obvious. By looking for not-so-obvious correlations, we can generate further questions as to why they might exist, or if they are some unusual 'quirk' of the dataset.

### Function Implementations

```{r}
perm_mean <- function(perms = 1000, all_values, n_A)
{
  ## Variables ##
  # perms: The number of permutations 
  # all_values (num): 
  # n1 (int): Size of group 1
  ###############
  
  # Step 1:
  # Create vector of zeroes of length "perms" to store
  # permuted mean differnces
  output <- numeric(perms)
  # Loop throught number of permutations
  for (i in c(1:perms))
  {
    # Step 2:
    # Randomly separate vector "all_values" into disjoint 
    # groups of size "n1" and "length(all_values) - n1" respectively
    samp <- sample(all_values, n_A)
    rand1 <- all_values[samp]     # Adds the sample values to one group
    rand2 <- all_values[-samp]    # Adds all the values not in the sample to the second group
    # Step 3:
    # Compute the sample means for the two groups from 
    # step 2
    mean1 <- mean(rand1)
    mean2 <- mean(rand2)
    # Step 4: 
    # Compute the difference in sample means, store the
    # value in the vector from step 1
    output[i] <- (mean1 - mean2)
  }
  
  # Step 5:
  # Return new updated vector, created in step 1
  return(output)
}
```

```{r}
perm_cor <- function(perms = 1000, x, y)
{
  ## Variables ##
  # perms: The number of permutations 
  # x: Vector 1 - for computing correlation
  # y: Vector 2 - for computing correlation
  ###############
  
  # Step 1:
  # Create vector of zeroes of length "perms" to store
  # permuted mean differnces
  output <- numeric(perms)
  # Loop throught number of permutations
  for (i in c(1:perms))
  {
    # Step 2:
    # Randomly mix up the values in the vector "y"
    rand <- sample(y)
    # Step 3:
    # Compute the correlation between x and the randomly mixed
    # up y-vector. Store this value in the vector from step 1.
    output[i] <- cor(x,rand,method="pearson")
  }
  
  # Step 4:
  # Return new updated vector, created in step 1
  return(output)
}
```

### Conclusions and Visualizations

#### Two-Sample Permutation Test

To compare rich and poor countries, we looked at the top and bottom 500 richest/poorest by per capita GDP. The actual difference in their means:
```{r}
low_gdp <- data %>%
  filter(min_rank(gdpPercap)<=500)
high_gdp <- data %>%
  filter(min_rank(desc(gdpPercap))<=500)
low_and_high_gdp <- low_gdp %>% full_join(high_gdp)
(actual_mean <- mean(low_gdp$lifeExp)-mean(high_gdp$lifeExp))
```
Running our permuted means test, we found our actual mean was at the 0th percentile of our randomized test:
```{r}
perm_mean_test <- perm_mean(1000,low_and_high_gdp$lifeExp,length(low_gdp$lifeExp))

percentile_mean_test <- ecdf(perm_mean_test)
percentile_mean_test(actual_mean)
range(perm_mean_test)

ggplot(tibble(perm_mean_test))+
  geom_histogram(aes(perm_mean_test),bins=50)+
  geom_vline(xintercept = actual_mean, color = 'red')+
  ylab("Number of Tests")+
  xlab("Difference in Means")+
  ggtitle("Two-Sample Permutation Test for High and Low GDP Countries")
```

Our p value for this test is basically 0: if the null hypothesis (that the difference in means is zero) were true, we would never expect to see a difference as large as our actual value. Therefore, we reject the null hypothesis in favor of the alternate hypothesis: the difference of means of high and low gdp countries is non-zero.

#### Linear Correlation Permutation Test

This test was based on our second question. We found that, for the Americas continent only, population and life expectancy were weakly positively correlated.

Running our correlation test and getting the actual correlation:
```{r}
america <- data %>% filter(continent == "Americas")
cor_test <- (perm_cor(1000,america$pop,america$lifeExp))
(cor_act <- cor(america$pop,america$lifeExp))
```
Our result is in the 100th percentile of our linear correlation permutation test:
```{r}
percentiles_cor_test <- ecdf(cor_test)
percentiles_cor_test(cor_act) 
range(cor_test) 

ggplot(tibble(cor_test))+
  geom_histogram(aes(cor_test),bins = 50)+
  geom_vline(xintercept = cor_act, color = 'red')+
  ylab("Number of Tests")+
  xlab("Pearson Correlation Coefficient")+
  ggtitle("Linear Correlation Permutation Test for Population and Life Expectancy in the Americas")
```

Our p-value for this correlation is essentially 0: if no correlation exists, our random tests never reach a correlation as high as our actual observed value. So, we have evidence to reject the null hypothesis that population and life expectancy in the Americas are not correlated, in favor of the alternate hypothesis that some correlation exists.

This correlation suggests that, in the Americas continent, life expectancy is slightly higher in the more populous countries.

### Individual Contributions

**Andrew:**

**Brian:** I helped formulate ideas for both tests and compiled our ideas together. I also came up with the idea to look for a strange correlation in the initial dataset, which we can then further investigate in the updated dataset.

**Charles:**

**Clint:**


