---
title: 'Lab 10: Text and Time Analysis'
author: "Brian Teklits, Charles Doremieux, Andrew MacLean, Clint LaBattaglia"
date: "11/01/2019"
output: html_document
---

```{r setup, include=FALSE}
library(tidyverse)
library(stringr)
library(lubridate)
knitr::opts_chunk$set(warning=FALSE,message=FALSE)
Que <- read_csv("Questions_trunc.csv")
Ans <- read_csv("Answers_trunc.csv")
Ans <- Ans %>%
  mutate(ans_time = ymd_hms(CreationDate))
Que <- Que %>%
  mutate(ask_time = ymd_hms(CreationDate))
Q_and_A <- Que %>%
  left_join(Ans, by = c("Id" = "ParentId")) %>%
  mutate(time_to_ans = CreationDate.y-CreationDate.x)
Q_and_A <- Q_and_A %>%
  select(-CreationDate.x,-CreationDate.y,-X7.x,-X7.y)
Q_and_A <- Q_and_A %>%
  rename(Score_Que = Score.x, AnswerId = Id.y, Id_Asked = OwnerUserId.x, ID_Answered = OwnerUserId.y, QuestionBody = Body.x, AnswerBody = Body.y, Score_Ans = Score.y)
```
### Findings and Features

**Notable Features:** What affects score and why

**Ideal question and answer:**

#### Timeliness as a Feature

First, the timeliness variable must be created. The time_to_ans variable describes the number of minutes between the posting of a question and an answer. Answers are ranked in order of response:
```{r}
Q_and_A2 <- Q_and_A %>%
  group_by(Id) %>%
  mutate(Timeliness = min_rank(time_to_ans))
```
Most questions receive only a few answers, so the earliest answer ranks are the most crowded:
```{r}
(Ans_per_Timeli <- Q_and_A2 %>%
  group_by(Timeliness) %>%
  count())
```
So, to compare across ranks, we summarize the total score at each rank and divide by the number of answers at that rank:
```{r}
(Score_per_Ans <- Q_and_A2 %>%
  group_by(Timeliness) %>%
  summarize(timeScore = sum(Score_Ans)) %>%
  group_by(Timeliness) %>%
  left_join(Ans_per_Timeli,by="Timeliness")%>%
  summarize(Score_per_Ans = timeScore/n))
```

```{r}
ggplot()+
geom_line(data=Score_per_Ans,aes(Timeliness,Score_per_Ans))+
  geom_hline(aes(yintercept=mean(Q_and_A2$Score_Ans,na.rm=TRUE),color='Sample Average'),linetype='dashed')+
  scale_color_manual(name='',values=c(`Sample Average`='red'))+
  ggtitle("Average Answer Score by Response Order")+
  ylab("Average Score")+
  xlab("Answer in Order of Response")
```

Earlier responses don't outscore later responses, in general they fall very close to the average score. Some of the late responses score far above the average: questions which generate a lot of responses are more nuanced and it takes longer for a person with the adequate knowledge to respond. Additionally, only 4 questions received more than 20 responses, so the averages at these ranks are heavily weighted by any high scoring response.

#### Is answer score normally distributed?

```{r}
ggplot(Q_and_A2,aes(Score_Ans))+
  geom_histogram(bins = 100)+
  geom_vline(aes(xintercept=mean(Q_and_A2$Score_Ans,na.rm=TRUE),color='Mean'),linetype='dashed')+
  geom_vline(aes(xintercept=median(Q_and_A2$Score_Ans,na.rm=TRUE),color='Median'),linetype='dashed')+
  scale_color_manual(name='Statistics',values=c(Mean='red',Median='blue'))+
  xlim(-3,25)+
  ggtitle("Distribution of Answer Scores")+
  ylab("Number of Answers")+
  xlab("Score")
```

Score is not normally distributed; a normal distribution is centered on the mean. The presence of extreme outliers (one question received a score of 8384) skews the mean away from where the majority of answer scores fall. We are able to compute percentiles and z-scores, but they will be similarly skewed, and thus not as meaningful as for a normal distribution.

**Benefits of this analysis:** Recommendations for question and answer styling could be incorporated into a Stack Overflow beginner's guide.

### Individual Findings

#### Andrew
What features did you create and why did you choose those features?
What is the relationship between your features and the scores of questions/answers if any? Provide an explanation for why each relationship does/does not exist.

#### Brian
```{r}
test <- Q_and_A2 %>%
  mutate(Inc_Code = str_detect(AnswerBody,"<code>"))
p1 <- test %>%
  group_by(Inc_Code)%>%
  summarize(total = sum(Score_Ans))
p2 <- test %>%
  group_by(Inc_Code) %>%
  count()
p3 <- p1 %>%
  left_join(p2) %>%
  group_by(Inc_Code) %>%
  summarize(tot_per = total/n)
```

```{r}
t2 <- Q_and_A2 %>%
  mutate(need = str_count(QuestionBody,regex("need",ignore_case = TRUE)))
c1 <- t2 %>%
  group_by(need) %>%
  count()
c2 <- t2 %>%
  group_by(need) %>%
  summarize(tot = sum(Score_Que)) %>%
  group_by(need) %>%
  left_join(c1) %>%
  summarize(tot_per = tot/n)
```
```{r}
ggplot(c2,aes(need,tot_per))+
  geom_point()+
  geom_smooth(method='lm')
```

#### Charles
What features did you create and why did you choose those features?
What is the relationship between your features and the scores of questions/answers if any? Provide an explanation for why each relationship does/does not exist.

#### Clint
What features did you create and why did you choose those features?
What is the relationship between your features and the scores of questions/answers if any? Provide an explanation for why each relationship does/does not exist.
